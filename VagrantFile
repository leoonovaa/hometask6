Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"
  config.vm.hostname = "lvm-lab"

  config.vm.provider "virtualbox" do |vb|
    vb.memory = 1024
    vb.cpus = 1

    vb.customize ["createhd", "--filename", "anna_disk1.vdi", "--size", 400]
    vb.customize ["createhd", "--filename", "anna_disk2.vdi", "--size", 400]
    vb.customize ["createhd", "--filename", "anna_disk3.vdi", "--size", 400]
    vb.customize ["createhd", "--filename", "anna_disk4.vdi", "--size", 400]

    vb.customize ["storageattach", :id, "--storagectl", "SATA Controller", "--port", 1, "--device", 0, "--type", "hdd", "--medium", "anna_disk1.vdi"]
    vb.customize ["storageattach", :id, "--storagectl", "SATA Controller", "--port", 2, "--device", 0, "--type", "hdd", "--medium", "anna_disk2.vdi"]
    vb.customize ["storageattach", :id, "--storagectl", "SATA Controller", "--port", 3, "--device", 0, "--type", "hdd", "--medium", "anna_disk3.vdi"]
    vb.customize ["storageattach", :id, "--storagectl", "SATA Controller", "--port", 4, "--device", 0, "--type", "hdd", "--medium", "anna_disk4.vdi"]
  end

  config.vm.provision "shell", inline: <<-SHELL
    set -eux

    for disk in sdb sdc sdd sde; do
      parted /dev/$disk --script mklabel gpt mkpart primary 0% 100%
    done

    pvcreate /dev/sdb1
    pvcreate /dev/sdc1
    pvcreate /dev/sdd1
    pvcreate /dev/sde1

    vgcreate myvg /dev/sdb1 /dev/sdc1 /dev/sdd1 /dev/sde1

    lvcreate -L 750M -n vol0 myvg
    lvcreate -L 750M -n vol1 myvg

    mkfs.ext4 /dev/myvg/vol0
    mkfs.ext4 /dev/myvg/vol1

    mkdir -p /mnt/vol0
    mkdir -p /mnt/vol1

    mount /dev/myvg/vol0 /mnt/vol0
    mount /dev/myvg/vol1 /mnt/vol1

    echo "/dev/myvg/vol0 /mnt/vol0 ext4 defaults 0 0" >> /etc/fstab
    echo "/dev/myvg/vol1 /mnt/vol1 ext4 defaults 0 0" >> /etc/fstab
  SHELL

end
